<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>なつめゲーム</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #game-container {
            display: flex;
            gap: 20px;
        }
        canvas {
            border: 1px solid black;
        }
        #side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            text-align: center;
            display: none;
        }
        #continue-button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }

        /* スマホ向けのスタイル */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
            }
            #game-container {
                flex-direction: column;
                align-items: center;
            }
            #gameCanvas {
                width: 100%;
                height: auto;
            }
            #nextFruitCanvas,
            #fruitEvolutionCanvas {
                width: 80px;
                height: 80px;
            }
            #side-panel {
                flex-direction: row;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas" width="400" height="600"></canvas>
        <div id="side-panel">
            <canvas id="nextFruitCanvas" width="100" height="100"></canvas>
            <canvas id="fruitEvolutionCanvas" width="200" height="200"></canvas>
        </div>
    </div>
    <div id="game-over">
        <h2>ゲームオーバー</h2>
        <p>スコア: <span id="final-score"></span></p>
        <button id="continue-button">続ける</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const nextFruitCanvas = document.getElementById('nextFruitCanvas');
        const nextFruitCtx = nextFruitCanvas.getContext('2d');
        const fruitEvolutionCanvas = document.getElementById('fruitEvolutionCanvas');
        const fruitEvolutionCtx = fruitEvolutionCanvas.getContext('2d');
        const gameOverElement = document.getElementById('game-over');
        const finalScoreElement = document.getElementById('final-score');
        const continueButton = document.getElementById('continue-button');

        const physics = {
            gravity: 0.5,
            restitution: 0.3,
            friction: 0.99,
            collisionDamping: 0.8
        };

        const fruits = [
            {name: 'さくらんぼ', image: './images/sakuranbo.png', radius: 15},
            {name: 'いちご', image: './images/ichigo.png', radius: 20},
            {name: 'ぶどう', image: './images/budou.png', radius: 26},
            {name: 'デコポン', image: './images/decopon.png', radius: 33},
            {name: 'かき', image: './images/kaki.png', radius: 41},
            {name: 'りんご', image: './images/ringo.png', radius: 50},
            {name: 'なし', image: './images/nasi.png', radius: 60},
            {name: 'もも', image: './images/momo.png', radius: 71},
            {name: 'パイナップル', image: './images/painappuru.png', radius: 83},
            {name: 'メロン', image: './images/meron.png', radius: 96},
            {name: 'スイカ', image: './images/suika.png', radius: 110}
        ];

        let fruitImages = {};
        let imagesLoaded = 0;
        let totalImages = fruits.length;

        fruits.forEach(fruit => {
            let img = new Image();
            img.onload = () => {
                imagesLoaded++;
                if (imagesLoaded === totalImages) {
                    startGame();
                }
            };
            img.src = fruit.image;
            fruitImages[fruit.name] = img;
        });

        let currentFruit = null;
        let nextFruit = null;
        let droppedFruits = [];
        let score = 0;
        let gameOver = false;
        const gameOverLine = 100;

        function createFruit(x, y, fruitIndex) {
            return {
                x: x,
                y: y,
                fruit: fruits[fruitIndex],
                vx: 0,
                vy: 0,
                grounded: false
            };
        }

        function drawFruit(ctx, fruit, x, y) {
            const img = fruitImages[fruit.fruit.name];
            const size = fruit.fruit.radius * 2;
            ctx.drawImage(img, x - size/2, y - size/2, size, size);
        }

        function drawNextFruit() {
            nextFruitCtx.clearRect(0, 0, nextFruitCanvas.width, nextFruitCanvas.height);
            nextFruitCtx.font = '16px Arial';
            nextFruitCtx.fillStyle = 'black';
            nextFruitCtx.fillText('NEXT', 10, 20);

            const originalRadius = nextFruit.fruit.radius;
            nextFruit.fruit.radius = 30; // すべてのフルーツを同じ大きさに設定
            drawFruit(nextFruitCtx, nextFruit, nextFruitCanvas.width / 2, nextFruitCanvas.height / 2);
            nextFruit.fruit.radius = originalRadius; // 元の大きさに戻す
        }

        function drawFruitEvolution() {
            fruitEvolutionCtx.clearRect(0, 0, fruitEvolutionCanvas.width, fruitEvolutionCanvas.height);
            const centerX = fruitEvolutionCanvas.width / 2;
            const centerY = fruitEvolutionCanvas.height / 2;
            const radius = Math.min(centerX, centerY) - 30;

            // 円形の矢印を描画
            drawCircularArrow(fruitEvolutionCtx, centerX, centerY, radius);

            fruits.forEach((fruit, index) => {
                const angle = (index / fruits.length) * Math.PI * 2 - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;

                const originalRadius = fruit.radius;
                fruit.radius = 15; // すべてのフルーツを同じ大きさに設定
                drawFruit(fruitEvolutionCtx, {fruit: fruit}, x, y);
                fruit.radius = originalRadius; // 元の大きさに戻す
            });
        }

        function drawCircularArrow(ctx, x, y, radius) {
            ctx.save();
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            const arrowHeadLength = 10;
            const arrowAngle = Math.PI / 6;
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + radius - arrowHeadLength * Math.cos(arrowAngle), y - arrowHeadLength * Math.sin(arrowAngle));
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + radius - arrowHeadLength * Math.cos(arrowAngle), y + arrowHeadLength * Math.sin(arrowAngle));
            ctx.stroke();
            ctx.restore();
        }

        function drawGameOver() {
            gameOverElement.style.display = 'block';
            finalScoreElement.textContent = score;
        }

        function startGame() {
            score = 0;
            gameOver = false;
            droppedFruits = [];
            gameOverElement.style.display = 'none';
            currentFruit = createFruit(canvas.width / 2, 0, 0);
            nextFruit = createFruit(canvas.width / 2, 0, Math.floor(Math.random() * fruits.length));
            drawNextFruit();
            drawFruitEvolution();
            requestAnimationFrame(gameLoop);
        }

        function gameLoop() {
            if (gameOver) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            if (currentFruit) {
                currentFruit.vy += physics.gravity;
                currentFruit.x += currentFruit.vx;
                currentFruit.y += currentFruit.vy;

                if (currentFruit.y + currentFruit.fruit.radius > canvas.height) {
                    currentFruit.y = canvas.height - currentFruit.fruit.radius;
                    currentFruit.vy *= -physics.restitution;
                    currentFruit.vx *= physics.friction;
                    currentFruit.grounded = true;
                }

                if (currentFruit.grounded) {
                    droppedFruits.push(currentFruit);
                    checkForMerges();
                    if (currentFruit.y < gameOverLine) {
                        gameOver = true;
                        drawGameOver();
                    } else {
                        currentFruit = nextFruit;
                        nextFruit = createFruit(canvas.width / 2, 0, Math.floor(Math.random() * fruits.length));
                        drawNextFruit();
                    }
                }
            }

            droppedFruits.forEach(fruit => {
                fruit.vy += physics.gravity;
                fruit.x += fruit.vx;
                fruit.y += fruit.vy;

                if (fruit.y + fruit.fruit.radius > canvas.height) {
                    fruit.y = canvas.height - fruit.fruit.radius;
                    fruit.vy *= -physics.restitution;
                    fruit.vx *= physics.friction;
                    fruit.grounded = true;
                }
            });

            resolveCollisions();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            droppedFruits.forEach(fruit => drawFruit(ctx, fruit, fruit.x, fruit.y));
            if (currentFruit) drawFruit(ctx, currentFruit, currentFruit.x, currentFruit.y);
        }

        function resolveCollisions() {
            for (let i = 0; i < droppedFruits.length; i++) {
                for (let j = i + 1; j < droppedFruits.length; j++) {
                    const f1 = droppedFruits[i];
                    const f2 = droppedFruits[j];
                    const dx = f2.x - f1.x;
                    const dy = f2.y - f1.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const minDistance = f1.fruit.radius + f2.fruit.radius;

                    if (distance < minDistance) {
                        const angle = Math.atan2(dy, dx);
                        const targetX = f1.x + Math.cos(angle) * minDistance;
                        const targetY = f1.y + Math.sin(angle) * minDistance;
                        const ax = (targetX - f2.x) * physics.collisionDamping;
                        const ay = (targetY - f2.y) * physics.collisionDamping;

                        f1.vx -= ax;
                        f1.vy -= ay;
                        f2.vx += ax;
                        f2.vy += ay;
                    }
                }
            }
        }

        function checkForMerges() {
            for (let i = 0; i < droppedFruits.length; i++) {
                for (let j = i + 1; j < droppedFruits.length; j++) {
                    const f1 = droppedFruits[i];
                    const f2 = droppedFruits[j];
                    const dx = f2.x - f1.x;
                    const dy = f2.y - f1.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const minDistance = f1.fruit.radius + f2.fruit.radius;

                    if (distance < minDistance && f1.fruit === f2.fruit) {
                        const newFruitIndex = fruits.indexOf(f1.fruit) + 1;
                        if (newFruitIndex < fruits.length) {
                            const newFruit = createFruit((f1.x + f2.x) / 2, (f1.y + f2.y) / 2, newFruitIndex);
                            droppedFruits.push(newFruit);
                            droppedFruits.splice(j, 1);
                            droppedFruits.splice(i, 1);
                            score += 10;
                            return;
                        }
                    }
                }
            }
        }

        continueButton.addEventListener('click', startGame);

        startGame();
    </script>
</body>
</html>
